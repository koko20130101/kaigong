<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>地图中心</title>
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/font/iconfont.css" media="all">
    <script src="../../layuiadmin/font/iconfont.js"></script>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">
            <form class="layui-form" action="" lay-filter="component-form-group">
                <div class="layui-form-item">
                    <div class="layui-inline w80">
                        <select name="quiz">
                            <option value="0">全部</option>
                            <option value="1">离线</option>
                            <option value="2">行驶</option>
                            <option value="3">停止</option>
                            <option value="4">卸料</option>
                            <option value="5">卸过料</option>
                            <option value="6">报警</option>
                        </select>
                    </div>
                    <div class="layui-inline">
                        <div class="select-date">
                            <div class="layui-input-inline">
                                <input type="text" name="startDate" id="Start-date" lay-verify="date"
                                       placeholder="年-月-日  时:分:秒" autocomplete="off" class="layui-input">
                            </div>
                            <div class="layui-form-mid">-</div>
                            <div class="layui-input-inline">
                                <input type="text" name="endDate" id="End-date" lay-verify="date"
                                       placeholder="年-月-日  时:分:秒" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <input type="text" name="contractNumber" placeholder="请输入车辆编号" lay-verify="required"
                               class="layui-input">
                    </div>
                    <div class="layui-inline">
                        <a class="layui-btn layui-btn-sm layui-btn-sm" lay-submit>查询</a>
                        </a>
                    </div>
                </div>
            </form>
            <div class="car-state" style="top:3px;">
                <span class="layui-badge-dot layui-bg-green"></span>行驶
                <span class="layui-badge-dot"></span>停止
                <span class="layui-badge-dot layui-bg-blue"></span>卸料
                <span class="layui-badge-dot layui-bg-cyan"></span>卸过料
                <span class="layui-badge-dot layui-bg-gray"></span>无信号
                <span class="layui-badge-dot layui-bg-orange"></span>报警
            </div>
        </div>
        <div class="layui-card-body">
            <div class="truck-list">
                <table class="layui-hide" id="Trucks" lay-filter="orderExamine"></table>
                <script type="text/html" id="StateDemo">
                    {{# if(d.state ==1){ }}
                        <div class="layui-bg-green">{{ d.truckNumber }}</div>
                    {{# } }}
                    {{# if(d.state ==2){ }}
                    <div class="layui-bg-red">{{ d.truckNumber }}</div>
                    {{# } }}
                    {{# if(d.state ==3){ }}
                    <div class="layui-bg-blue">{{ d.truckNumber }}</div>
                    {{# } }}
                    {{# if(d.state ==4){ }}
                    <div class="layui-bg-cyan">{{ d.truckNumber }}</div>
                    {{# } }}
                    {{# if(d.state ==5){ }}
                    <div class="layui-bg-gray">{{ d.truckNumber }}</div>
                    {{# } }}
                    {{# if(d.state ==6){ }}
                    <div class="layui-bg-orange">{{ d.truckNumber }}</div>
                    {{# } }}
                </script>
            </div>
            <div class="map-box">
                <div id="allmap"></div>
                <div class="layui-form map-search">
                    <div class="layui-form-item no-margin">
                        <div class="layui-inline w400">
                            <input type="text" name="title" required="" lay-verify="required" placeholder="请输入要搜索的地点名称"
                                   autocomplete="off" class="layui-input" id="txtAddress">
                        </div>
                        <div class="layui-inline">
                            <button class="layui-btn layui-btn-normal" id="seacrch" onclick="doSearch();">搜索</button>
                        </div>
                        <div id="searchResultPanel"></div>
                    </div>
                </div>
                <div class="tools">
                    <div class="layui-btn-group">
                        <a class="layui-btn layui-btn-primary layui-btn-sm" id="Traffic">
                            <i class="layui-icon icon-close">
                                <svg class="icon" aria-hidden="true">
                                    <use xlink:href="#icon-lukuang1"></use>
                                </svg>
                            </i>
                            <i class="layui-icon icon-open" style="display: none">
                                <svg class="icon" aria-hidden="true">
                                    <use xlink:href="#icon-lukuang"></use>
                                </svg>
                            </i>
                            路况</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="../../layuiadmin/layui/layui.js"></script>
<script src="../../layuiadmin/js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2&amp;ak=gxoEbH7Fj52wc1LVwRsGGOC5"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?v=2.0&amp;ak=gxoEbH7Fj52wc1LVwRsGGOC5&amp;services=&amp;t=20190123111209"></script>

<script>
    layui.config({
        base: '../../layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['element', 'index', 'table'], function () {
        var $ = layui.$
                , table = layui.table
                , element = layui.element
                , laydate = layui.laydate;
        table.render({
            elem: '#Trucks',
            height: 'full-100',
            cols: [[
                {field: 'truckNumber', title: '车号', align: 'center', width: 63,templet: '#StateDemo'}
                , {field: 'plateNumber', title: '车牌', align: 'center'}
            ]],
            data: [
                {
                    "truckNumber": "123",
                    "plateNumber": "粤T38786",
                    "state": 1
                }, {
                    "truckNumber": "133",
                    "plateNumber": "粤T38786",
                    "state": 2
                }, {
                    "truckNumber": "123",
                    "plateNumber": "粤T38786",
                    "state": 3
                }, {
                    "truckNumber": "123",
                    "plateNumber": "粤T38786",
                    "state": 4
                }, {
                    "truckNumber": "133",
                    "plateNumber": "粤T38786",
                    "state": 5
                }, {
                    "truckNumber": "123",
                    "plateNumber": "粤T38786",
                    "state": 6
                }
            ]
        });

        $('#Traffic').on('click', function () {
            var $this = $(this);

            if($this.hasClass('opened')){
                $this.find('.icon-open').hide();
                $this.find('.icon-close').show();
                $this.removeClass('opened');
            }else{
                $this.find('.icon-open').show();
                $this.find('.icon-close').hide();
                $this.addClass('opened');
            }
        });
    })
</script>
<script type="text/javascript">
    $(function () {
        $('#allmap').css('height', $(window).height() - 60 + 'px');
    });

    var _point; //存储坐标的地址对象
    // 百度地图API功能
    function G(id) {
        return document.getElementById(id);
    }

    var map = new BMap.Map("allmap");
    var lng = '113.2603470';
    var lat = '22.9772870';

    map.addEventListener("click", showInfo);
    if (lng == '' || lat == '') {
        map.centerAndZoom('广州', 15); // 初始化地图,设置城市和地图级别。
    }
    else {
        var point = new BMap.Point(lng, lat);  // 创建点坐标
        var marker = new BMap.Marker(point);  // 创建标注
        map.addOverlay(marker);              // 将标注添加到地图中
        map.centerAndZoom(point, 15); // 初始化地图,设置城市和地图级别。
    }
    map.enableScrollWheelZoom(); //启动滚轮放大缩小
    map.addControl(new BMap.NavigationControl({
        anchor: BMAP_ANCHOR_TOP_RIGHT,
        type: BMAP_NAVIGATION_CONTROL_SMALL
    })); //右上角，仅包含平移和缩放按钮
    var ac = new BMap.Autocomplete( //建立一个自动完成的对象
            {
                "input": "txtAddress",
                "location": map
            });

    ac.addEventListener("onhighlight", function (e) { //鼠标放在下拉列表上的事件
        var str = "";
        var _value = e.fromitem.value;
        var value = "";
        if (e.fromitem.index > -1) {
            value = _value.province + _value.city + _value.district + _value.street + _value.business;
        }
        str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

        value = "";
        if (e.toitem.index > -1) {
            _value = e.toitem.value;
            value = _value.province + _value.city + _value.district + _value.street + _value.business;
        }
        str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
        G("searchResultPanel").innerHTML = str;
    });

    var myValue;
    ac.addEventListener("onconfirm", function (e) { //鼠标点击下拉列表后的事件
        var _value = e.item.value;
        myValue = _value.province + _value.city + _value.district + _value.street + _value.business;
        G("searchResultPanel").innerHTML = "onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue;
        _point = e.target.yd.src.BC;
        setPlace();
    });

    function setPlace() {
        map.clearOverlays(); //清除地图上所有覆盖物
        function myFun() {
            var pp = local.getResults().getPoi(0).point; //获取第一个智能搜索的结果
            map.centerAndZoom(pp, 18);
            map.addOverlay(new BMap.Marker(pp)); //添加备注
        }

        var local = new BMap.LocalSearch(map, {
            onSearchComplete: myFun
        });
        local.search(myValue);
    }
    var marker;
    var geoc = new BMap.Geocoder();

    function showInfo(e) {
        if (marker) {
            map.removeOverlay(marker);
        }
        marker = new BMap.Marker(new BMap.Point(e.point.lng, e.point.lat));
        lng = e.point.lng;
        lat = e.point.lat;
        _point = e.point;
        console.log(_point);
        map.addOverlay(marker); // 将标注添加到地图中
        //通过点击百度地图，可以获取到对应的point, 由point的lng、lat属性就可以获取对应的经度纬度
        var pt = e.point;
        geoc.getLocation(pt, function (rs) {
            //addressComponents对象可以获取到详细的地址信息
            var addComp = rs.addressComponents;
            var site = addComp.province + "" + addComp.city + "" + addComp.district + "" + addComp.street + "" + addComp.streetNumber;
            //将对应的HTML元素设置值
            console.log('hajaja' + site)
            $('#txtAddress').val(site);
        });
    }

    //map展现结果的地图实例
    //autoViewport检索结束后是否自动调整地图视野
    var local = new BMap.LocalSearch(map, {
        renderOptions: {
            map: map,
            autoViewport: true
        }
    });
    //地址检索
    function doSearch() {
        var address = document.getElementById("txtAddress").value;
        local.search(address);

        //检索结束后的回调方法
        local.setSearchCompleteCallback(function (results) {
            // 判断状态是否正确
            if (local.getStatus() == BMAP_STATUS_SUCCESS) {
                _point = results.Br[0].point;
            }
        });
    }


    function getMap() {
        var win = top.frames["Form"];
        if (!win) {
            win = top.CashForm;
        }
        if (!win) {
            win = $.parentWindow();
        }
        var lng = _point.lng;
        var lat = _point.lat;
        console.log(_point);
        win.setMap($('#txtAddress').val(), lat, lng);
        var index = top.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        top.layer.close(index);
    }
</script>
</body>
</html>